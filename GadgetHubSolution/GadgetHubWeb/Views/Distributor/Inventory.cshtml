@model List<DistributorInventoryDto>
@{
    ViewData["Title"] = "Inventory Management";
    Layout = "_DistributorLayout";
}

<!-- ✅ ADD ANTI-FORGERY TOKEN -->
@Html.AntiForgeryToken()

<div class="inventory-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 fw-bold mb-2">
                    <i class="fas fa-boxes text-info me-3"></i>Inventory Management
                </h1>
                <p class="text-muted mb-0">Manage your product inventory, pricing, and stock levels</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="inventory-stats">
                    @if (ViewBag.InventoryStats != null)
                    {
                        var stats = ViewBag.InventoryStats;
                        <span class="badge bg-info rounded-pill fs-6 me-2">@stats.TotalItems Products</span>
                        <span class="badge bg-success rounded-pill fs-6">@stats.InStockItems In Stock</span>
                        @if (stats.LowStockItems > 0)
                        {
                            <span class="badge bg-warning rounded-pill fs-6 ms-1">@stats.LowStockItems Low Stock</span>
                        }
                        @if (stats.OutOfStockItems > 0)
                        {
                            <span class="badge bg-danger rounded-pill fs-6 ms-1">@stats.OutOfStockItems Out of Stock</span>
                        }
                    }
                    else
                    {
                        <span class="badge bg-info rounded-pill fs-6 me-2">@Model.Count Products</span>
                        <span class="badge bg-success rounded-pill fs-6">@Model.Count(p => p.Stock > 0) In Stock</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="bulkUpdatePrices()">
                                <i class="fas fa-dollar-sign me-1"></i>Bulk Update Prices
                            </button>
                            <button class="btn btn-success" onclick="bulkUpdateStock()">
                                <i class="fas fa-boxes me-1"></i>Bulk Update Stock
                            </button>
                            <button class="btn btn-warning" onclick="exportInventory()">
                                <i class="fas fa-download me-1"></i>Export Data
                            </button>
                            <!-- ✅ ADD DIAGNOSTIC BUTTON -->
                            <button class="btn btn-info" onclick="runDiagnostics()" title="Test system connectivity">
                                <i class="fas fa-stethoscope me-1"></i>Test System
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="search-box">
                            <input type="text" class="form-control" placeholder="Search products..." id="inventorySearch">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (Model.Any())
    {
        <!-- Inventory Table -->
        <div class="inventory-table">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-list text-secondary me-2"></i>Product Inventory
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Current Price</th>
                                    <th>Stock Level</th>
                                    <th>Delivery Days</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    var stockStatus = item.Stock > 10 ? "In Stock" : item.Stock > 0 ? "Low Stock" : "Out of Stock";
                                    var stockClass = item.Stock > 10 ? "success" : item.Stock > 0 ? "warning" : "danger";

                                    <tr id="product_@item.ProductId">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="https://via.placeholder.com/50x50?text=IMG"
                                                     alt="@item.ProductName" class="product-thumbnail me-3">
                                                <div>
                                                    <h6 class="mb-0 fw-bold">@item.ProductName</h6>
                                                    <small class="text-muted">@item.ProductBrand</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@item.Category</span>
                                        </td>
                                        <td>
                                            <div class="price-input-group">
                                                <div class="input-group input-group-sm" style="max-width: 120px;">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control"
                                                           value="@item.Price.ToString("F2")"
                                                           step="0.01"
                                                           id="price_@item.ProductId"
                                                           onchange="updatePrice(@item.ProductId)">
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="stock-input-group">
                                                <div class="input-group input-group-sm" style="max-width: 100px;">
                                                    <input type="number" class="form-control"
                                                           value="@item.Stock"
                                                           min="0"
                                                           id="stock_@item.ProductId"
                                                           onchange="updateStock(@item.ProductId)">
                                                    <span class="input-group-text">pcs</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="delivery-input-group">
                                                <div class="input-group input-group-sm" style="max-width: 90px;">
                                                    <input type="number" class="form-control"
                                                           value="@item.DeliveryDays"
                                                           min="1"
                                                           max="365"
                                                           id="delivery_@item.ProductId"
                                                           onchange="updateDelivery(@item.ProductId)">
                                                    <span class="input-group-text">d</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-@stockClass" id="status_@item.ProductId">@stockStatus</span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn btn-outline-success btn-sm me-1"
                                                        onclick="quickRestock(@item.ProductId)"
                                                        data-bs-toggle="tooltip" title="Quick Restock">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm me-1"
                                                        onclick="saveChanges(@item.ProductId)"
                                                        data-bs-toggle="tooltip" title="Save Changes">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm"
                                                        onclick="removeFromInventory(@item.ProductId)"
                                                        data-bs-toggle="tooltip" title="Remove from Inventory">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- No Inventory State -->
        <div class="no-inventory-container text-center py-5">
            <div class="no-inventory-content">
                <i class="fas fa-warehouse fa-5x text-muted mb-4"></i>
                <h2 class="fw-bold mb-3">No Inventory Data</h2>
                <p class="text-muted mb-4 lead">
                    Your inventory appears to be empty. Don't worry - we can automatically set up inventory for all available products!
                </p>

                <div class="no-inventory-actions mb-4">
                    <button class="btn btn-primary btn-lg rounded-pill px-5 me-3" onclick="initializeInventory()">
                        <i class="fas fa-magic me-2"></i>Initialize Inventory
                    </button>
                    <button class="btn btn-success btn-lg rounded-pill px-5 me-3" onclick="refreshInventory()">
                        <i class="fas fa-refresh me-2"></i>Refresh Inventory
                    </button>
                    <a href="@Url.Action("Index", "Distributor")" class="btn btn-outline-primary btn-lg rounded-pill px-5">
                        <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                    </a>
                </div>

                <!-- Help Section -->
                <div class="help-section mt-5">
                    <h5 class="fw-bold mb-3">Getting Started with Inventory</h5>
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-3">
                            <div class="help-card text-center p-3">
                                <i class="fas fa-plus-circle fa-2x text-primary mb-2"></i>
                                <h6 class="fw-bold">Auto-Initialize</h6>
                                <p class="text-muted small">Click "Initialize Inventory" to automatically add all products</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="help-card text-center p-3">
                                <i class="fas fa-edit fa-2x text-success mb-2"></i>
                                <h6 class="fw-bold">Set Prices</h6>
                                <p class="text-muted small">Update prices and stock levels for each product</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="help-card text-center p-3">
                                <i class="fas fa-file-invoice-dollar fa-2x text-warning mb-2"></i>
                                <h6 class="fw-bold">Get Quotes</h6>
                                <p class="text-muted small">Start receiving quotation requests from customers</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="help-card text-center p-3">
                                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                <h6 class="fw-bold">Track Performance</h6>
                                <p class="text-muted small">Monitor your sales and inventory performance</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Connection Status -->
                <div class="connection-status mt-4">
                    <small class="text-muted">
                        <i class="fas fa-wifi me-1"></i>
                        API Connection: <span id="apiStatus" class="text-info">Checking...</span>
                    </small>
                </div>
            </div>
        </div>
    }
</div>

<!-- Quick Restock Modal -->
<div class="modal fade" id="restockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Quick Restock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="restockForm">
                    <div class="mb-3">
                        <label class="form-label">Add Stock Quantity</label>
                        <input type="number" class="form-control" id="restockQuantity" min="1" value="10" required>
                        <div class="form-text">Enter the number of units to add to current stock</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="restockNotes" rows="2" placeholder="Restock reason or notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmRestock()">
                    <i class="fas fa-check me-1"></i>Add Stock
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentProductId = null;
        let pendingChanges = {};

        function updatePrice(productId) {
            const newPrice = document.getElementById(`price_${productId}`).value;
            console.log(`Price changed for product ${productId} to $${newPrice}`);
            
            // Store pending change
            if (!pendingChanges[productId]) {
                pendingChanges[productId] = {};
            }
            pendingChanges[productId].price = parseFloat(newPrice);
            
            // Highlight the row to show it has unsaved changes
            const row = document.getElementById(`product_${productId}`);
            row.classList.add('table-warning');
        }

        function updateStock(productId) {
            const newStock = document.getElementById(`stock_${productId}`).value;
            console.log(`Stock changed for product ${productId} to ${newStock} units`);
            
            // Store pending change
            if (!pendingChanges[productId]) {
                pendingChanges[productId] = {};
            }
            pendingChanges[productId].stock = parseInt(newStock);
            
            // Update stock status badge immediately for UI feedback
            updateStockStatusBadge(productId, parseInt(newStock));
            
            // Highlight the row to show it has unsaved changes
            const row = document.getElementById(`product_${productId}`);
            row.classList.add('table-warning');
        }

        function updateDelivery(productId) {
            const newDelivery = document.getElementById(`delivery_${productId}`).value;
            console.log(`Delivery days changed for product ${productId} to ${newDelivery} days`);
            
            // Store pending change
            if (!pendingChanges[productId]) {
                pendingChanges[productId] = {};
            }
            pendingChanges[productId].deliveryDays = parseInt(newDelivery);
            
            // Highlight the row to show it has unsaved changes
            const row = document.getElementById(`product_${productId}`);
            row.classList.add('table-warning');
        }

        function updateStockStatusBadge(productId, stockValue) {
            const statusBadge = document.getElementById(`status_${productId}`);
            
            if (stockValue > 10) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'In Stock';
            } else if (stockValue > 0) {
                statusBadge.className = 'badge bg-warning';
                statusBadge.textContent = 'Low Stock';
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Out of Stock';
            }
        }

        function saveChanges(productId) {
            const changes = pendingChanges[productId];
            if (!changes) {
                alert('No changes to save for this product');
                return;
            }

            const price = changes.price || parseFloat(document.getElementById(`price_${productId}`).value);
            const stock = changes.stock || parseInt(document.getElementById(`stock_${productId}`).value);
            const deliveryDays = changes.deliveryDays || parseInt(document.getElementById(`delivery_${productId}`).value);

            // Show loading state
            const row = document.getElementById(`product_${productId}`);
            const saveBtn = row.querySelector('.btn-outline-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            saveBtn.disabled = true;

            // ✅ FIXED: Get anti-forgery token properly
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            if (!token) {
                console.error('❌ Anti-forgery token not found');
                alert('Security token missing. Please refresh the page and try again.');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                return;
            }

            console.log(`🔄 Saving changes for product ${productId}: Price=${price}, Stock=${stock}, DeliveryDays=${deliveryDays}`);

            // Send update request
            fetch('@Url.Action("UpdateInventory", "Distributor")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}&price=${price}&stock=${stock}&deliveryDays=${deliveryDays}&__RequestVerificationToken=${encodeURIComponent(token)}`
            })
            .then(response => {
                console.log(`📥 Response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`📊 Response data:`, data);
                if (data.success) {
                    // Remove pending changes
                    delete pendingChanges[productId];
                    
                    // Remove warning highlight and show success
                    row.classList.remove('table-warning');
                    row.classList.add('table-success');
                    
                    // Update stock status badge
                    updateStockStatusBadge(productId, stock);
                    
                    setTimeout(() => {
                        row.classList.remove('table-success');
                    }, 2000);
                    
                    console.log('✅ Inventory updated successfully');
                    
                    // Show success notification
                    showNotification('Inventory updated successfully!', 'success');
                } else {
                    console.error('❌ Server returned error:', data.message);
                    alert('Error updating inventory: ' + (data.message || 'Unknown error'));
                    row.classList.add('table-danger');
                    setTimeout(() => row.classList.remove('table-danger'), 3000);
                }
            })
            .catch(error => {
                console.error('❌ Network or parsing error:', error);
                alert('Error updating inventory: ' + error.message + '. Please check your connection and try again.');
                row.classList.add('table-danger');
                setTimeout(() => row.classList.remove('table-danger'), 3000);
            })
            .finally(() => {
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // ✅ NEW: Show notification helper
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function quickRestock(productId) {
            currentProductId = productId;
            document.getElementById('restockForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('restockModal'));
            modal.show();
        }

        function confirmRestock() {
            const quantity = parseInt(document.getElementById('restockQuantity').value);
            const notes = document.getElementById('restockNotes').value;

            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }

            // Update the stock input
            const currentStock = parseInt(document.getElementById(`stock_${currentProductId}`).value);
            const newStock = currentStock + quantity;
            document.getElementById(`stock_${currentProductId}`).value = newStock;

            // Update pending changes and save immediately
            updateStock(currentProductId);
            saveChanges(currentProductId);

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('restockModal')).hide();

            console.log(`✅ Added ${quantity} units to inventory. New stock level: ${newStock}`);
        }

        function removeFromInventory(productId) {
            if (!confirm('Are you sure you want to remove this product from your inventory?')) {
                return;
            }

            // ✅ FIXED: Get anti-forgery token properly
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            if (!token) {
                console.error('❌ Anti-forgery token not found');
                alert('Security token missing. Please refresh the page and try again.');
                return;
            }

            console.log(`🗑️ Removing product ${productId} from inventory`);

            // Send remove request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("RemoveFromInventory", "Distributor")';
            
            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = 'productId';
            productIdInput.value = productId;
            
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = token;
            
            form.appendChild(productIdInput);
            form.appendChild(tokenInput);
            document.body.appendChild(form);
            form.submit();
        }

        function bulkUpdatePrices() {
            const percentage = prompt('Enter percentage change (e.g., 10 for +10%, -5 for -5%):');
            if (percentage !== null && !isNaN(percentage)) {
                if (confirm(`Apply ${percentage}% price change to all products?`)) {
                    const priceInputs = document.querySelectorAll('[id^="price_"]');
                    priceInputs.forEach(input => {
                        const currentPrice = parseFloat(input.value);
                        const newPrice = currentPrice * (1 + parseFloat(percentage) / 100);
                        input.value = newPrice.toFixed(2);

                        // Trigger update for each product
                        const productId = input.id.split('_')[1];
                        updatePrice(productId);
                    });

                    alert(`Applied ${percentage}% price change to all products. Remember to save changes for each product.`);
                }
            }
        }

        function bulkUpdateStock() {
            const quantity = prompt('Enter stock quantity to add to all products:');
            if (quantity !== null && !isNaN(quantity) && parseInt(quantity) > 0) {
                if (confirm(`Add ${quantity} units to all products?`)) {
                    const stockInputs = document.querySelectorAll('[id^="stock_"]');
                    stockInputs.forEach(input => {
                        const currentStock = parseInt(input.value);
                        const newStock = currentStock + parseInt(quantity);
                        input.value = newStock;

                        // Trigger update for each product
                        const productId = input.id.split('_')[1];
                        updateStock(productId);
                    });

                    alert(`Added ${quantity} units to all products. Remember to save changes for each product.`);
                }
            }
        }

        function exportInventory() {
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
            btn.disabled = true;

            // Navigate to export endpoint
            window.location.href = '@Url.Action("ExportInventory", "Distributor")';

            // Restore button after a delay
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }

        function refreshInventory() {
            location.reload();
        }

        // ✅ NEW: Initialize inventory function
        function initializeInventory() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            // Show loading
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Initializing...';
            btn.disabled = true;
            
            // Make API call to initialize inventory
            fetch('@Url.Action("Inventory", "Distributor")', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(() => {
                // Reload the page to show the initialized inventory
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('❌ Failed to initialize inventory. Please try again or contact support.');
            });
        }

        // ✅ NEW: Check API connection status
        function checkApiConnection() {
            fetch('/Home/TestApiConnection')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    if (data.ApiConnection) {
                        statusElement.textContent = 'Connected';
                        statusElement.className = 'text-success';
                    } else {
                        statusElement.textContent = 'Disconnected';
                        statusElement.className = 'text-danger';
                    }
                }
            })
            .catch(error => {
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.textContent = 'Error';
                    statusElement.className = 'text-danger';
                }
            });
        }

        // ✅ NEW: Diagnostic test function
        function runDiagnostics() {
            console.log('🧪 Running system diagnostics...');
            
            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
            btn.disabled = true;
            
            fetch('@Url.Action("TestInventoryUpdate", "Distributor")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `__RequestVerificationToken=${encodeURIComponent(document.querySelector('input[name="__RequestVerificationToken"]')?.value || '')}`
            })
            .then(response => {
                console.log(`🧪 Diagnostic response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('🧪 Diagnostic results:', data);
                
                let message = `🧪 SYSTEM DIAGNOSTICS RESULTS:\n\n`;
                message += `✅ Test completed: ${data.success ? 'PASSED' : 'FAILED'}\n`;
                message += `📋 Message: ${data.message}\n\n`;
                
                if (data.diagnosticInfo) {
                    message += `👤 User ID: ${data.diagnosticInfo.UserId}\n`;
                    message += `📧 User Name: ${data.diagnosticInfo.UserName}\n`;
                    message += `🔐 Authenticated: ${data.diagnosticInfo.IsAuthenticated}\n`;
                    message += `🎭 Distributor Role: ${data.diagnosticInfo.UserRole}\n\n`;
                }
                
                if (data.inventoryTest) {
                    message += `📦 Inventory API Test: ${data.inventoryTest.success ? 'PASSED' : 'FAILED'}\n`;
                    message += `📊 Items Found: ${data.inventoryTest.itemCount}\n`;
                    if (data.inventoryTest.message) {
                        message += `📝 API Message: ${data.inventoryTest.message}\n`;
                    }
                }
                
                if (data.apiError) {
                    message += `\n❌ API Error: ${data.apiError}`;
                }
                
                alert(message);
                
                // Show notification
                showNotification(
                    data.success ? 'System diagnostics passed!' : 'System diagnostics failed!',
                    data.success ? 'success' : 'error'
                );
            })
            .catch(error => {
                console.error('🧪 Diagnostic test failed:', error);
                alert(`🧪 DIAGNOSTIC TEST FAILED:\n\n❌ Error: ${error.message}\n\nCheck console for details.`);
                showNotification('Diagnostic test failed!', 'error');
            })
            .finally(() => {
                // Restore button
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Search functionality
        document.getElementById('inventorySearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const productName = row.querySelector('h6').textContent.toLowerCase();
                const brand = row.querySelector('small').textContent.toLowerCase();
                const category = row.querySelector('.badge').textContent.toLowerCase();

                if (productName.includes(searchTerm) || brand.includes(searchTerm) || category.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // ✅ NEW: Check API connection on page load
        if (document.getElementById('apiStatus')) {
            checkApiConnection();
        }

        // Auto-save warning for unsaved changes
        window.addEventListener('beforeunload', function (e) {
            if (Object.keys(pendingChanges).length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });

        // Check API connection status (simulated)
        setTimeout(() => {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = 'Connected';
            apiStatus.classList.remove('text-info');
            apiStatus.classList.add('text-success');
        }, 1500);
    </script>
}